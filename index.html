<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MH Roster to Google Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Identity Services Library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        .drop-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .drop-zone.active {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .loader {
            border-top-color: #3498db;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans">
    <div class="max-w-4xl mx-auto py-10 px-4">
        <header class="text-center mb-10">
            <h1 class="text-3xl font-bold text-slate-800 flex items-center justify-center gap-3">
                <i class="fas fa-plane-departure text-blue-600"></i>
                MH Roster Sync
            </h1>
            <p class="text-slate-600 mt-2">Upload your iFlight roster screenshot to sync flights to Google Calendar</p>
        </header>

        <div id="auth-section" class="bg-white rounded-xl shadow-sm p-8 text-center mb-6">
            <i class="fas fa-calendar-check text-5xl text-blue-500 mb-4"></i>
            <h2 class="text-xl font-semibold mb-2">Connect your Calendar</h2>
            <p class="text-slate-500 mb-6">We need permission to add events to your Google Calendar.</p>
            <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition-colors inline-flex items-center gap-2">
                <i class="fab fa-google"></i>
                Sign in with Google
            </button>
        </div>

        <div id="main-app" class="hidden space-y-6">
            <!-- Upload Section -->
            <div class="bg-white rounded-xl shadow-sm p-8">
                <div id="drop-zone" class="drop-zone rounded-lg p-10 text-center cursor-pointer">
                    <input type="file" id="file-input" class="hidden" accept="image/*">
                    <i class="fas fa-cloud-upload-alt text-4xl text-slate-400 mb-3"></i>
                    <p class="text-slate-700 font-medium">Click to upload or drag & drop</p>
                    <p class="text-slate-400 text-sm mt-1">iFlight Roster Screenshot (PNG/JPG)</p>
                </div>
                
                <div id="preview-container" class="mt-6 hidden">
                    <p class="text-sm font-semibold text-slate-500 mb-2 uppercase tracking-wider">Preview</p>
                    <img id="image-preview" src="" alt="Roster Preview" class="max-h-64 mx-auto rounded border">
                    <div class="mt-4 flex justify-center">
                        <button id="process-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg flex items-center gap-2">
                            <i class="fas fa-magic"></i>
                            Extract Flight Details
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading-overlay" class="hidden bg-white rounded-xl shadow-sm p-12 text-center">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div>
                <h3 class="text-lg font-semibold text-slate-800">Analyzing Roster...</h3>
                <p class="text-slate-500">Extracting flight numbers, times, and destinations.</p>
            </div>

            <!-- Results Section -->
            <div id="results-section" class="hidden bg-white rounded-xl shadow-sm p-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-slate-800">Detected Flights</h2>
                    <span id="flight-count" class="bg-blue-100 text-blue-700 text-xs font-bold px-2.5 py-0.5 rounded-full">0 Flights</span>
                </div>
                
                <div id="flights-list" class="space-y-3">
                    <!-- Flight cards will be injected here -->
                </div>

                <div class="mt-8 flex justify-end gap-3">
                    <button id="reset-btn" class="text-slate-500 hover:text-slate-700 font-medium px-4">Clear All</button>
                    <button id="sync-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg flex items-center gap-2">
                        <i class="fas fa-sync"></i>
                        Sync to Calendar
                    </button>
                </div>
            </div>
        </div>

        <div id="status-msg" class="fixed bottom-6 right-6 hidden bg-slate-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 animate-bounce">
            <span id="msg-text">Done!</span>
            <button onclick="this.parentElement.classList.add('hidden')" class="text-slate-400 hover:text-white">&times;</button>
        </div>
    </div>

    <script type="module">
        // Configuration: Replace these with your actual IDs from Google Cloud Console
        const apiKey = "AIzaSyDi6E0J8UFOHXYIthGYdeLA99dinkJ-qPw"; // Gemini API Key
        const clientId = "869881743231-sdl15avujlkejme3vod4k3cl4401n1uq.apps.googleusercontent.com"; // Google OAuth Client ID
        const model = "gemini-2.5-flash-preview-09-2025";
        
        // UI Elements
        const authSection = document.getElementById('auth-section');
        const mainApp = document.getElementById('main-app');
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const previewContainer = document.getElementById('preview-container');
        const imagePreview = document.getElementById('image-preview');
        const processBtn = document.getElementById('process-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const resultsSection = document.getElementById('results-section');
        const flightsList = document.getElementById('flights-list');
        const syncBtn = document.getElementById('sync-btn');
        const resetBtn = document.getElementById('reset-btn');
        const flightCountBadge = document.getElementById('flight-count');

        let detectedFlights = [];
        let base64Image = null;
        let tokenClient = null;
        let accessToken = null;

        // Initialize Google Identity Services
        window.onload = () => {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: 'https://www.googleapis.com/auth/calendar.events',
                callback: (response) => {
                    if (response.error !== undefined) {
                        showMessage("Authorization failed", true);
                        return;
                    }
                    accessToken = response.access_token;
                    authSection.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                },
            });
        };

        document.getElementById('login-btn').onclick = () => {
            // Request token from user
            tokenClient.requestAccessToken({ prompt: 'consent' });
        };

        // --- Upload Logic ---
        dropZone.onclick = () => fileInput.click();
        
        dropZone.ondragover = (e) => {
            e.preventDefault();
            dropZone.classList.add('active');
        };

        dropZone.ondragleave = () => dropZone.classList.remove('active');

        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('active');
            handleFiles(e.dataTransfer.files);
        };

        fileInput.onchange = (e) => handleFiles(e.target.files);

        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    base64Image = e.target.result.split(',')[1];
                    imagePreview.src = e.target.result;
                    previewContainer.classList.remove('hidden');
                    dropZone.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        // --- API Logic ---
        async function callGemini(imageContent) {
            const prompt = `Extract all flight duties from this iFlight crew portal roster. 
            Ignore "Day Off" (D) or "Earned Day Off" (DO) entries.
            For each flight, provide:
            1. Flight Number (Item)
            2. Departure Date (DD-MMM-YYYY)
            3. Departure Airport Code (Dep)
            4. Arrival Airport Code (Arr)
            5. Departure Time (Start) in LOCAL
            6. Arrival Time (End) in LOCAL
            
            Return ONLY a JSON array of objects. Format: 
            [{"flightNumber": "MH 156", "date": "02-MAR-2026", "dep": "KUL", "arr": "JED", "startTime": "17:30", "endTime": "23:40"}]`;

            let retries = 0;
            const maxRetries = 5;
            
            while (retries < maxRetries) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: prompt },
                                    { inlineData: { mimeType: "image/jpeg", data: imageContent } }
                                ]
                            }],
                            generationConfig: {
                                responseMimeType: "application/json"
                            }
                        })
                    });

                    if (!response.ok) throw new Error('API request failed');
                    
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    return JSON.parse(text);
                } catch (error) {
                    retries++;
                    const delay = Math.pow(2, retries) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error('Failed after multiple retries');
        }

        processBtn.onclick = async () => {
            if (!base64Image) return;
            
            previewContainer.classList.add('hidden');
            loadingOverlay.classList.remove('hidden');
            
            try {
                detectedFlights = await callGemini(base64Image);
                renderFlights();
                loadingOverlay.classList.add('hidden');
                resultsSection.classList.remove('hidden');
            } catch (err) {
                showMessage("Failed to extract data. Please try a clearer screenshot.", true);
                loadingOverlay.classList.add('hidden');
                previewContainer.classList.remove('hidden');
            }
        };

        function renderFlights() {
            flightsList.innerHTML = '';
            flightCountBadge.innerText = `${detectedFlights.length} Flights`;
            
            detectedFlights.forEach((flight, index) => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-4 border border-slate-100 rounded-lg hover:bg-slate-50 transition-colors";
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center font-bold text-xs">
                            ${flight.flightNumber.includes(' ') ? flight.flightNumber.split(' ')[1] : 'MH'}
                        </div>
                        <div>
                            <p class="font-bold text-slate-800">${flight.flightNumber}</p>
                            <p class="text-sm text-slate-500">${flight.date} • ${flight.dep} ➔ ${flight.arr}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-semibold text-slate-700">${flight.startTime} - ${flight.endTime}</p>
                        <button class="text-xs text-red-500 hover:text-red-700 mt-1" onclick="removeFlight(${index})">Remove</button>
                    </div>
                `;
                flightsList.appendChild(div);
            });
        }

        window.removeFlight = (index) => {
            detectedFlights.splice(index, 1);
            renderFlights();
        };

        function parseDateTime(dateStr, timeStr) {
            // input: "02-MAR-2026", "17:30"
            // Note: Months in JS are 0-indexed (JAN=0, FEB=1...)
            const months = {
                'JAN': 0, 'FEB': 1, 'MAR': 2, 'APR': 3, 'MAY': 4, 'JUN': 5,
                'JUL': 6, 'AUG': 7, 'SEP': 8, 'OCT': 9, 'NOV': 10, 'DEC': 11
            };
            const [day, mon, year] = dateStr.split('-');
            const [hour, min] = timeStr.split(':');
            return new Date(year, months[mon.toUpperCase()], day, hour, min).toISOString();
        }

        syncBtn.onclick = async () => {
            if (!accessToken) {
                showMessage("Please log in again.", true);
                return;
            }

            syncBtn.disabled = true;
            syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
            
            let successCount = 0;

            for (const flight of detectedFlights) {
                try {
                    const startDateTime = parseDateTime(flight.date, flight.startTime);
                    const endDateTime = parseDateTime(flight.date, flight.endTime);

                    const event = {
                        'summary': `${flight.flightNumber} (${flight.dep}-${flight.arr})`,
                        'description': `Automated roster sync\nFrom: ${flight.dep}\nTo: ${flight.arr}`,
                        'start': { 'dateTime': startDateTime, 'timeZone': 'UTC' }, // Adjust timeZone if needed
                        'end': { 'dateTime': endDateTime, 'timeZone': 'UTC' },
                    };

                    const response = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(event)
                    });

                    if (response.ok) successCount++;
                } catch (err) {
                    console.error("Sync error:", err);
                }
            }
            
            showMessage(`Successfully synced ${successCount} flights!`);
            syncBtn.disabled = false;
            syncBtn.innerHTML = '<i class="fas fa-sync"></i> Sync to Calendar';
        };

        resetBtn.onclick = () => {
            detectedFlights = [];
            resultsSection.classList.add('hidden');
            dropZone.classList.remove('hidden');
            fileInput.value = '';
            previewContainer.classList.add('hidden');
        };

        function showMessage(text, isError = false) {
            const msg = document.getElementById('status-msg');
            const txt = document.getElementById('msg-text');
            txt.innerText = text;
            msg.className = `fixed bottom-6 right-6 ${isError ? 'bg-red-600' : 'bg-green-600'} text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 animate-bounce`;
            msg.classList.remove('hidden');
            setTimeout(() => msg.classList.add('hidden'), 5000);
        }
    </script>
</body>
</html>

